name: Deploy LoopBack 4 to K3s via Tailscale

on:
  push:
    branches:
      - dev
      - main
  workflow_dispatch:

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Test
        run: npm run test

  deploy:
    needs: ci
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set deployment variables
        run: |
          BRANCH=${GITHUB_REF#refs/heads/}
          case "$BRANCH" in
            dev)
              BACKEND_NAME="backend-dev"
              ;;
            main)
              BACKEND_NAME="backend-main"
              ;;
            *)
              echo "Invalid branch for deployment" && exit 1
              ;;
          esac
          IMAGE_TAG="${{ github.ref_name }}-${{ github.sha }}"
          IMAGE_REGISTRY="selecro"
          echo "IMAGE_NAME=${IMAGE_REGISTRY}/${BACKEND_NAME}:${IMAGE_TAG}" >> $GITHUB_ENV
          echo "SHORT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_ACCESS_TOKEN }}

      - name: Build and push Docker image
        run: |
          docker build -t ${{ env.IMAGE_NAME }} .
          docker push ${{ env.IMAGE_NAME }}

      - name: Install and authenticate Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --auth-key=${{ secrets.TAILSCALE_AUTH_KEY }}
          sudo tailscale status

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Configure kubectl
        run: |
          echo "${{ secrets.K3S_KUBECONFIG }}" | base64 -d > kubeconfig.yaml
          echo "KUBECONFIG=$(pwd)/kubeconfig.yaml" >> $GITHUB_ENV

      - name: Check Cluster Connection
        run: kubectl cluster-info

      - name: Apply Kubernetes Manifests
        run: |
          envsubst < k8s/deployment.yaml | kubectl apply -f -
          envsubst < k8s/service.yaml | kubectl apply -f -

      - name: Wait for Deployment to be Ready
        run: |
          kubectl rollout status deployment/loopback4-backend --BACKEND_NAME=${{ env.BACKEND_NAME }} --timeout=60s

      - name: Clean up
        if: always()
        run: rm -f kubeconfig.yaml
